---
layout: post
title: CLR
date: 2024-06-15 20:00 +0900
categories: [.NET]
tags: [dotnet, .net, clr]

---

## CLR

.NET은 코드를 실행하고 개발 프로세스를 더 쉽게 만드는 런타임 환경 Common Language Runtime(CLR)을 제공합니다.

컴파일러와 툴은 CLR의 기능 및 관리형 실행 환경의 이점을 활용하는 코드를 작성할 수 있게 해줍니다. 런타임을 대상으로 하는 컴파일러를 사용해 개발하는 코드를 관리 코드(managed code)라고 합니다. 관리 코드는 언어간 통합, 예외처리, 보안, 버전 관리 및 배포 지원, 요소 상호 작용을 위한 간단한 모델, 디버깅 및 프로파일링 서비스 등의 다양한 기능을 지원합니다.

.NET 5 이후의 릴리스는 별도의 CLR 버전 없이 동일한 CLR 버전을 제공하지만, .NET Framework의 버전과 CLR의 버전이 반드시 일치하진 않습니다.

## 관리형 실행 프로세스(Managed execution process)

관리형 실행 프로세스는 C++, C#, F#, VB 등의 여러 언어를 통합해 실행하는 일련의 프로세스라고 할 수 있습니다.

### 컴파일러 선택

런타임을 대상으로 지정하는 언어 컴파일러를 하나 이상 사용해야 합니다.

CLR은 다국어 실행 환경이므로, 런타임은 다양한 데이터 형식 및 언어 기능을 지원해야 합니다. 언어 컴파일러에 따라 사용할 수 있는 런타임 기능이 결정되고, 개발자는 해당 기능을 사용해 코드를 디자인 할 수 있습니다. 즉 코드의 구문, 문법 설정은 컴파일러가 맡아야 합니다. 한 언어는 다른 언어의 CLS([공용 언어 사양](https://learn.microsoft.com/ko-kr/dotnet/standard/language-independence))에 포함된 기능만을 사용할 수 있습니다.[^1]

### 코드 -> CIL 컴파일

컴파일러는 코드를 CIL(Common Intermediate Language)로 컴파일합니다. CIL은 네이티브 코드로 효율적으로 변환될 수 있는 CPU 독립적인 명령 집합으로 함수의 로드, 저장, 초기화, 호출 명령 및 연산, 제어 흐름, 메모리 엑세스, 예외 처리 및 기타 작업에 대한 명령어가 포함됩니다.[^2]

컴파일러는 CIL 생성 시 메타데이터를 생성합니다. 메타데이터는 형식의 정의, 멤버의 서명, 참조하는 멤버, 런타임시 사용하는 기타 데이터를 포함해 코드의 형식에 대해 설명합니다. CIL, 메타데이터는 실행 가능한 컨텐츠에 대해 Microsoft PE, COFF(Common Object File Format)를 기반으로 확장하는 PE(이식 가능한 파일)에 포함합니다. 이 파일을 통해 OS에서 CLR 이미지를 인식할 수 있고, 코드 자체를 설명할 수 있습니다. 런타임은 실행 중에 필요한 메타 데이터를 찾아 추출할 수 있습니다.

### CIL -> Native code 컴파일

CIL을 실행하기 위해 CLR을 기반으로 MSIL을 대상 CPU 아키텍처에 대한 네이티브 코드로 컴파일 해야 합니다. .NET은 .NET JIT, Ngen.exe 두가지 방법을 제공합니다.

#### JIT

JIT 컴파일러는 어셈블리의 컨텐츠를 로드, 앱의 실행 중 요청 시 CIL을 네이티브 코드로 변환합니다. CLR은 각 CPU 아키텍처에 대한 JIT 컴파일러를 제공하므로 다양한 아키텍처에서 실행될 수 있는 CIL 어셈블리 집합을 빌드 할 수 있습니다. 단 플랫폼 특정 API 혹은 라이브러리를 호출 할 경우 해당 OS에서만 실행 할 수 있습니다.

모든 CIL을 네이티브 코드로 변환하는 시간, 메모리를 절약하기 위해 필요에 따라 CIL을 네이티브 코드로 변환해 메모리에 저장합니다. 로더는 형식이 로드, 초기화될 때 스텁(stub)을 만들고 각 메서드에 연결합니다. 메서드가 처음 호출 될 시 스텁은 JIT 컴파일러로 제어를 전달, 컴파일러는 해당 메서드에 대한 CIL을 네이티브 코드로 변환해 스텁이 해당 네이티브 코드를 직접 가리키도록 수정합니다. 즉 한번 컴파일한 메서드에 대해선 직접 네이티브 코드로 실행 할 수 있습니다.

#### NGen.exe

JIT 컴파일러는 호출 시 CIL을 네이티브 코드로 변환해 런타임 성능이 저하 될 수 있는데, 대부분의 경우 허용 가능한 정도입니다. 문제는 JIT 컴파일러에서 생성된 코드는 트리거한 프로세스 이외의 프로세스로 공유가 불가능하다는 점입니다. 공유를 가능하게 하기 위해 [NGen.exe](https://learn.microsoft.com/ko-kr/dotnet/framework/tools/ngen-exe-native-image-generator)는 사전 컴파일 모드를 지원합니다. JIT 컴파일과 유사하지만, 다른 점이 몇 가지 있습니다.

* 런타임이 아닌 실행하기 이전, 컴파일 단계에서 CIL -> 네이티브 코드 변환을 실행합니다.
* 한번에 한 메서드가 아닌 어셈블리 전체를 컴파일합니다.
* 생성된 코드는 이미지 캐시에서 디스크의 물리적 파일로 유지합니다.

### 코드 확인

코드가 보안 정책을 무시하고록 지정한 경우가 아닌 경우, CIL -> 네이티브 코드 컴파일 중 확인 프로세스를 통과해야 합니다. 확인 프로세스는 CIL, 메타데이터를 검사해 형식 안전한 코드인지 확인해 메모리 엑세스 권한이 부여된 위치에만 엑세스 할 수 있습니다. 형식 안전성을 통해 개체를 격리해 우발적, 악의적 손상으로부터 보호할 수 있습니다.

예를 들어 코드가 메모리 스텀프 등 허용된 메모리 위치를 넘은 동작을 수행하는지 검사해 통과하지 못할 경우 예외를 발생합니다.

### 코드 실행

CLR은 실행을 가능하게 하는 인프라 및 실행 중에 사용할 수 있는 서비스를 제공합니다.

실행하는 동안 관리 코드는 GC, 보안, unmanaged code와의 상호 운용, 언어 간 디버깅, 배포/버전 관리 등의 서비스를 지원합니다. 해당 서비스는 OS에 의존합니다.

출처: MSDN [1](https://learn.microsoft.com/ko-kr/dotnet/standard/clr)  [2](https://learn.microsoft.com/ko-kr/dotnet/standard/managed-code)

[^1]: [CLSCompilantAttribute](https://learn.microsoft.com/ko-kr/dotnet/api/system.clscompliantattribute?view=net-8.0) 특성을 사용해 코드가 CLS 규격인지 확인 할 수 있습니다.
[^2]: [ILSpy](https://github.com/icsharpcode/ILSpy) 등의 툴을 사용해 CIL로 컴파일된 코드를 볼 수 있습니다.
